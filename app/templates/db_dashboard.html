<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Aggregator - Database Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            /* max-width: 1200px; */ /* Removed to allow full width layout */
            /* margin: 0 auto; */ /* Removed for full width */
            /* padding: 20px; */ /* Body padding removed, handled by inner containers */
            background-color: #f5f7fa;
            margin: 0; /* Ensure no default body margin */
            padding: 0; /* Ensure no default body padding */
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .articles-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f1f5f9;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .api-link {
            display: inline-block;
            margin-top: 10px;
            color: #3498db;
            text-decoration: none;
        }
        .api-link:hover {
            text-decoration: underline;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination a {
            color: #3498db;
            padding: 8px 16px;
            text-decoration: none;
            border: 1px solid #ddd;
            margin: 0 4px;
            border-radius: 4px;
        }
        .pagination a:hover {
            background-color: #f1f5f9;
        }
        .pagination a.active {
            background-color: #3498db;
            color: white;
            border: 1px solid #3498db;
        }
        .article-summary {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* New styles for additional visualizations */
        .full-width {
            grid-column: 1 / -1;
        }
        
        .chart-note {
            color: #7f8c8d;
            font-size: 12px;
            font-style: italic;
            margin-top: 5px;
        }

        /* --- Revamped Resizable Layout --- */
        .dashboard-container {
            display: grid;
            grid-template-columns: var(--sidebar-width, 320px) var(--resizer-width, 6px) 1fr var(--resizer-width, 6px) var(--articles-width, 400px);
            grid-template-rows: 1fr;
            height: calc(100vh - 70px);
            width: 100%;
            position: relative;
            min-width: 600px;
        }
        .sidebar {
            grid-column: 1;
            min-width: 180px;
            max-width: 600px;
            width: 100%;
            padding: 20px;
            background-color: #f0f0f0; /* Or a suitable color */
            overflow-y: auto;
            border-right: 1px solid #ccc;
            /* Fix: prevent horizontal overflow */
            overflow-x: auto;
            box-sizing: border-box;
            word-break: break-word;
        }
        /* Prevent content from overflowing horizontally in sidebar */
        .sidebar * {
            box-sizing: border-box;
            max-width: 100%;
            word-break: break-word;
        }
        .sidebar-resizer {
            grid-column: 2;
            cursor: col-resize;
            background: #ccc;
            width: var(--resizer-width, 6px);
            z-index: 10;
            transition: background 0.2s;
        }
        .sidebar-resizer.active,
        .sidebar-resizer:hover {
            background: #3498db;
        }
        .main-content {
            grid-column: 3;
            display: flex;
            flex-direction: column;
            min-width: 300px;
            overflow: hidden;
        }
        .graphs-column {
            flex: 1 1 auto;
            min-width: 300px;
            padding: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        .graphs-resizer {
            grid-column: 4;
            cursor: col-resize;
            background: #ccc;
            width: var(--resizer-width, 6px);
            z-index: 10;
            transition: background 0.2s;
        }
        .graphs-resizer.active,
        .graphs-resizer:hover {
            background: #3498db;
        }
        .articles-column {
            grid-column: 5;
            min-width: 220px;
            max-width: 700px;
            width: 100%;
            padding: 20px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            background-color: #fff;
        }
        #articles-list-placeholder {
            padding: 20px;
            text-align: center;
            color: #6c757d;
        }
        /* End New Dashboard Layout Styles */

        /* Styles for dynamically loaded articles list */
        .article-list-ul {
            list-style-type: none;
            padding: 0;
            text-align: left; /* Override parent's text-align */
        }
        .article-list-li {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .article-list-li:last-child {
            border-bottom: none;
        }
        .article-title a {
            font-weight: bold;
            font-size: 1.1em;
            color: #337ab7; /* Bootstrap link color for consistency */
            text-decoration: none;
            display: block; /* Makes the whole title area clickable */
            margin-bottom: 5px;
        }
        .article-title a:hover {
            text-decoration: underline;
        }
        .article-meta {
            font-size: 0.9em;
            color: #555;
        }
        /* End Styles for dynamically loaded articles list */

        /* Styling for sentiment articles display area */
        #sentimentArticlesDisplayArea {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
            min-height: 70px; /* Adjusted to accommodate title and messages */
        }
        #sentimentArticlesDisplayArea h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #2c3e50;
        }
        #sentimentArticlesDisplayArea ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        #sentimentArticlesDisplayArea li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        #sentimentArticlesDisplayArea li:last-child {
            border-bottom: none;
        }
        #sentimentArticlesDisplayArea a {
            text-decoration: none;
            color: #3498db;
            font-weight: 500;
        }
        #sentimentArticlesDisplayArea a:hover {
            text-decoration: underline;
        }
        #sentimentArticlesDisplayArea .source-name {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-left: 5px;
        }
        #sentimentArticlesDisplayArea .message {
            color: #555;
            font-style: italic;
        }

        /* Sidebar specific styles */
        .sidebar h2 {
            font-size: 1.2em; /* Slightly smaller heading */
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .sidebar button,
        .sidebar input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        
        /* Specific styling for buttons inside the analysis form to override default button styles if needed */
        .sidebar #analysisForm button {
            margin-top: 5px; /* Keep the small top margin for buttons in the form */
        }


        .sidebar .status-area,
        .sidebar #analysisResult {
            background-color: #fff; /* Or a slightly different shade from sidebar bg */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
            word-wrap: break-word; /* For analysisResult */
        }

        .sidebar .loader {
            margin: 5px auto 10px auto !important; /* Center loader if displayed as block/flex, added !important for inline style override */
            display: block !important; /* Ensure it behaves as a block for centering, overriding inline 'display: none/inline-flex' */
        }

        /* Adjustments if the buttons are inside a form or another div */
        .sidebar form { /* This will apply to the new <form> tag */
            display: flex;
            flex-direction: column;
        }

        /* --- Resizable Columns --- */
        .resizer {
            width: 6px;
            background: #ccc;
            cursor: col-resize;
            position: relative;
            z-index: 10;
            transition: background 0.2s;
        }
        .resizer:hover, .resizer.active {
            background: #3498db;
        }
    </style>
</head>
<body>
    <div class="header" style="overflow-y: hidden;">
        <h1>News Aggregator Database Dashboard</h1>
        <div>
            <a href="/docs" target="_blank" class="api-link">API Docs (Swagger)</a> |
            <a href="/redoc" target="_blank" class="api-link">API Docs (ReDoc)</a>
        </div>
    </div>

<div class="dashboard-container" id="dashboard-grid">
    <div class="sidebar" id="sidebar">
        <div class="action-section" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
            <h2>Article Actions</h2>
            <button id="fetchArticlesBtn" style="background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px;">Fetch New Articles</button>
            <div class="loader" id="fetchLoader" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin-left: 10px;"></div>
            <div class="status-area" id="fetchStatus" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #fdfdfd; min-height: 40px;">
                <p class="status-info" style="margin:0; color: #555;">Click to fetch articles from RSS feeds.</p>
            </div>
            <br>
            <button id="triageArticlesBtn" style="background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top:10px;">Triage New Articles (LLM Analysis)</button>
            <div class="loader" id="triageLoader" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin-left: 10px;"></div>
            <div class="status-area" id="triageStatus" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #fdfdfd; min-height: 40px;">
                <p class="status-info" style="margin:0; color: #555;">Click to perform LLM triage analysis.</p>
            </div>
        </div>

        <!-- Advanced Article Analysis Section -->
        <div class="articles-container" style="margin-top: 20px;">
            <h2>Advanced Article Analysis</h2>
            <form id="analysisForm">
                <label for="articleIdInput" style="margin-bottom: 5px; display: block;"><strong>Article ID:</strong></label>
                <input type="text" id="articleIdInput" name="article_id" placeholder="Enter Article ID">
                <button type="button" onclick="triggerDeepAnalysis()">Run Deep Analysis</button>
                <button type="button" onclick="triggerComparativeAnalysis()">Run Comparative Analysis</button>
            </form>
            <div id="analysisResult" style="background: #f8f9fa; border-radius: 6px; padding: 16px; min-height: 40px; margin-bottom: 10px; word-wrap: break-word;"></div>
            <div style="margin-top: 10px;">
                <a href="/docs#tag/Articles" class="api-link" target="_blank">API Docs: Article Analysis Endpoints →</a>
            </div>
        </div>
    </div>
    <div class="sidebar-resizer" id="sidebar-resizer"></div>
    <div class="main-content" id="main-content">
        <div class="graphs-column" id="graphs-column">
            <!-- Active Filters Display Area -->
            <div id="active-filters-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div id="active-filters-display" style="padding: 10px; background-color: #e9e9e9; border-radius: 4px; flex-grow: 1;">
                    <h4 style="margin: 0 0 5px 0; font-size: 0.9em;">Active Filters:</h4>
                    <span id="filters-list" style="font-size: 0.85em;">None</span>
                </div>
                <button id="clear-filters-btn" style="padding: 8px 15px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 15px;">Clear All Filters</button>
            </div>

            <div class="stats-container">
                <div class="stats-card">
                    <div class="stat-label">Total Articles</div>
                    <div class="stat-value">{{ total_articles }}</div>
                </div>
                <div class="stats-card">
                    <div class="stat-label">Storage Size</div>
                    <div class="stat-value">{{ storage_size_mb }} MB</div>
                </div>
                <div class="stats-card">
                    <div class="stat-label">Data Size</div>
                    <div class="stat-value">{{ data_size_mb }} MB</div>
                </div>
                <!-- New: LLM Analysis Stats -->
                <div class="stats-card">
                    <div class="stat-label">Triaged (LLM)</div>
                    <div class="stat-value">{{ triaged_count }}</div>
                </div>
                <div class="stats-card">
                    <div class="stat-label">Requires Deep Analysis</div>
                    <div class="stat-value">{{ requires_deep_count }}</div>
                </div>
                <div class="stats-card">
                    <div class="stat-label">Deep Analysis Done</div>
                    <div class="stat-value">{{ deep_analysis_done_count }}</div>
                </div>
                <div class="stats-card">
                    <div class="stat-label">Not Analyzed</div>
                    <div class="stat-value">{{ not_analyzed_count }}</div>
                </div>
            </div>
            <div class="chart-container">
                <!-- Analysis Status Pie Chart -->
                <div class="chart-card">
                    <h3>Article Analysis Status Distribution</h3>
                    <canvas id="analysisStatusChart"></canvas>
                    <div class="chart-note">Shows the distribution of articles by LLM analysis status.</div>
                </div>
            </div>

            <script>
                // Render the analysis status pie chart
            </script>
            
            <div class="chart-container">
                <div class="chart-card">
                    <h2>Articles by Source</h2>
                    <canvas id="sourceChart"></canvas>
                    <a href="/api/db/articles?aggregate=source_name" class="api-link">View API data →</a>
                </div>
                <div class="chart-card">
                    <h2>Articles by Category</h2>
                    <canvas id="categoryChart"></canvas>
                    <a href="/api/db/articles?aggregate=llm_category" class="api-link">View API data →</a>
                </div>
            </div>
            
            <!-- New visualizations -->
            <div class="chart-container">
                <!-- 1. Sentiment Analysis Chart -->
                <div class="chart-card">
                    <h2>Article Sentiment Distribution</h2>
                    <canvas id="sentimentChart"></canvas>
                    <a href="/api/db/articles?aggregate=llm_sentiment" class="api-link">View API data →</a>
                    <div id="sentimentArticlesDisplayArea">
                        <!-- Articles will be displayed here -->
                    </div>
                </div>
                
                <!-- 6. Deep Analysis Requirements -->
                <div class="chart-card">
                    <h2>Articles Requiring Deep Analysis</h2>
                    <canvas id="deepAnalysisRequiredChart"></canvas>
                    <a href="/api/db/articles?aggregate=llm_requires_deep_analysis" class="api-link">View API data →</a>
                    <div id="deepAnalysisRequiredFallback" style="color:#888; font-size:13px; margin-top:8px;"></div>
                </div>
            </div>
            
            <!-- Timeline Chart -->
            <div class="chart-container">
                <!-- 2. Publication Timeline -->
                <div class="chart-card full-width">
                    <h2>Publication Timeline</h2>
                    <canvas id="timelineChart"></canvas>
                    <a href="/api/db/articles?aggregate=publication_date" class="api-link">View API data →</a>
                </div>
            </div>
            
            <div class="chart-container">
                <!-- 4. Key Claims Analysis -->
                <div class="chart-card">
                    <h2>Top Key Claims</h2>
                    <canvas id="keyClaimsChart"></canvas>
                    <a href="/api/db/articles?aggregate=llm_key_claim" class="api-link">View API data →</a>
                    <div id="keyClaimsFallback" style="color:#888; font-size:13px; margin-top:8px;"></div>
                </div>
                
                <!-- 5. Source Reliability Metrics -->
                <div class="chart-card">
                    <h2>Source Reliability Scores (%)</h2>
                    <canvas id="reliabilityChart"></canvas>
                    <p class="chart-note">Higher score = fewer articles requiring deep analysis</p>
                    <div id="reliabilityFallback" style="color:#888; font-size:13px; margin-top:8px;"></div>
                </div>
            </div>
            
            <!-- Deep Analysis Stats Card -->
            <div class="stats-card full-width" style="margin-top: 20px;">
                <div class="stat-label">Articles with Deep Analysis</div>
                <div class="stat-value">{{ deep_analysis_count }}</div>
                <div class="stat-label">of {{ total_articles }} total articles</div>
            </div>
        </div>
    </div>
    <div class="graphs-resizer" id="graphs-resizer"></div>
    <div class="articles-column" id="articles-column">
        <div id="articles-list-placeholder">
            <h2>News Articles</h2>
            <p>Articles will be displayed here based on graph selections.</p>
        </div>
    </div>
</div>


    <script>
        // Render the analysis status pie chart
        document.addEventListener('DOMContentLoaded', function() {
            // Load articles into the right column
            loadArticles(activeFilters); // Pass activeFilters
            updateActiveFiltersDisplay(); // Initial display update

            // Clear All Filters Button Listener
            document.getElementById('clear-filters-btn').addEventListener('click', async () => {
                activeFilters = {}; // Reset filters
                await loadArticles(activeFilters); // Reload articles
                updateActiveFiltersDisplay(); // Update display
                // Optionally, reset chart visual cues here if implemented
            });

            // Add event listeners for Article Actions buttons
            document.getElementById('fetchArticlesBtn').addEventListener('click', async function() {
                const loader = document.getElementById('fetchLoader');
                const status = document.getElementById('fetchStatus');
                loader.style.display = 'inline-block';
                status.innerHTML = '<span style="color:#555;">Fetching articles...</span>';
                try {
                    const resp = await fetch('/api/articles/fetch', { method: 'POST' });
                    if (!resp.ok) {
                        let errMsg = 'Error fetching articles.';
                        try {
                            const err = await resp.json();
                            errMsg = err.detail || errMsg;
                        } catch {}
                        status.innerHTML = `<span style="color:#d9534f;">${errMsg}</span>`;
                    } else {
                        const data = await resp.json();
                        status.innerHTML = `<span style="color:#2ecc71;">${data.detail || 'Articles fetched successfully.'}</span>`;
                        // Optionally reload stats/charts here
                    }
                } catch (e) {
                    status.innerHTML = `<span style="color:#d9534f;">Request failed: ${e}</span>`;
                }
                loader.style.display = 'none';
            });

            document.getElementById('triageArticlesBtn').addEventListener('click', async function() {
                const loader = document.getElementById('triageLoader');
                const status = document.getElementById('triageStatus');
                loader.style.display = 'inline-block';
                status.innerHTML = '<span style="color:#555;">Running LLM triage analysis...</span>';
                try {
                    const resp = await fetch('/api/articles/triage', { method: 'POST' });
                    if (!resp.ok) {
                        let errMsg = 'Error running triage.';
                        try {
                            const err = await resp.json();
                            errMsg = err.detail || errMsg;
                        } catch {}
                        status.innerHTML = `<span style="color:#d9534f;">${errMsg}</span>`;
                    } else {
                        const data = await resp.json();
                        status.innerHTML = `<span style="color:#2ecc71;">${data.detail || 'Triage completed.'}</span>`;
                        // Optionally reload stats/charts here
                    }
                } catch (e) {
                    status.innerHTML = `<span style="color:#d9534f;">Request failed: ${e}</span>`;
                }
                loader.style.display = 'none';
            });

            const ctx = document.getElementById('analysisStatusChart').getContext('2d');
            const data = {
                labels: {{ analysis_status_distribution.keys() | list | tojson }},
                datasets: [{
                    data: {{ analysis_status_distribution.values() | list | tojson }},
                    backgroundColor: [
                        '#3498db', // Triaged
                        '#e67e22', // Requires Deep
                        '#2ecc71', // Deep Done
                        '#95a5a6'  // Not Analyzed
                    ],
                }]
            };
            new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        });
    </script>

    <script>
    let activeFilters = {}; // Global object to store active filters

    // Function to update the active filters display
    function updateActiveFiltersDisplay() {
        const filtersListSpan = document.getElementById('filters-list');
        if (Object.keys(activeFilters).length === 0) {
            filtersListSpan.textContent = 'None';
        } else {
            let filterStrings = [];
            for (const key in activeFilters) {
                // Make keys more readable
                let readableKey = key.replace('llm_', '').replace('_', ' ');
                readableKey = readableKey.charAt(0).toUpperCase() + readableKey.slice(1);
                if (key === 'source_name') readableKey = 'Source';
                 if (key === 'llm_requires_deep_analysis' && activeFilters[key] === 'true') {
                     filterStrings.push(`${readableKey}`); // Just "Requires Deep Analysis"
                 } else if (key === 'llm_requires_deep_analysis' && activeFilters[key] === 'false') {
                     filterStrings.push(`Not ${readableKey}`); // "Not Requires Deep Analysis"
                 }
                else {
                    filterStrings.push(`${readableKey}: ${activeFilters[key]}`);
                }
            }
            filtersListSpan.textContent = filterStrings.join('; ');
        }
    }

    // Generic chart click handler
    async function handleChartClick(event, elements, chartInstance, filterTypeKey) {
        if (elements.length > 0) {
            const clickedIndex = elements[0].index;
            const clickedLabel = chartInstance.data.labels[clickedIndex];

            // For boolean filters like 'llm_requires_deep_analysis', convert common labels to boolean strings
            let filterValue = clickedLabel;
            if (filterTypeKey === 'llm_requires_deep_analysis') {
                if (clickedLabel.toLowerCase() === 'requires deep analysis' || clickedLabel.toLowerCase() === 'true') {
                    filterValue = 'true';
                } else if (clickedLabel.toLowerCase() === 'standard analysis' || clickedLabel.toLowerCase() === 'false') {
                    filterValue = 'false';
                }
                // If it's already 'true' or 'false' from the data, it will be used as is.
            }


            if (activeFilters[filterTypeKey] === filterValue) {
                delete activeFilters[filterTypeKey]; // Toggle: deselect if already selected
                // Optionally, reset chart visual cues, e.g., remove border highlight
                elements[0].element.options.borderColor = chartInstance.data.datasets[elements[0].datasetIndex].borderColor[clickedIndex]; // Reset to original
                elements[0].element.options.borderWidth = chartInstance.data.datasets[elements[0].datasetIndex].borderWidth[clickedIndex]; // Reset to original

            } else {
                // Before setting a new filter, reset any visual cues on previously selected segments for this chart
                const dataset = chartInstance.data.datasets[elements[0].datasetIndex];
                dataset.data.forEach((_, index) => {
                    // This is tricky as chart.js elements don't directly expose their options for easy reset
                    // For simplicity, we won't try to reset borders of *other* segments here.
                    // A more robust solution might involve re-rendering or direct manipulation if Chart.js API allows.
                });

                activeFilters[filterTypeKey] = filterValue; // Select/update filter
                // Optionally, add visual cue, e.g., highlight border
                // elements[0].element.options.borderColor = 'rgba(0, 0, 0, 1)'; // Example: Black border
                // elements[0].element.options.borderWidth = 3; // Example: Thicker border
            }
            chartInstance.update(); // Re-render chart to apply visual cues if any changed in options

            // If sentiment filter is applied globally, clear the specific sentiment display area
            if (filterTypeKey === 'llm_sentiment' || activeFilters.hasOwnProperty('llm_sentiment')) {
                 const specificSentimentArea = document.getElementById('sentimentArticlesDisplayArea');
                 specificSentimentArea.innerHTML = '<p class="message">Global sentiment filter active. Articles below are filtered accordingly.</p>';
            }


            await loadArticles(activeFilters);
            updateActiveFiltersDisplay(); // Update display after filter change
        }
    }


    // Function to load articles into the articles column
    async function loadArticles(filters = {}) { // Renamed filterParams to filters for clarity
        const placeholder = document.getElementById('articles-list-placeholder');
        placeholder.innerHTML = '<p>Loading articles...</p>'; // Show loading message

        let baseUrl = '/api/db/articles';
        const queryParams = new URLSearchParams();
        
        // Pagination state
        let page = filters.page || 1;
        let limit = filters.limit || 10;
        let skip = (page - 1) * limit;

        queryParams.append('limit', limit);
        queryParams.append('skip', skip);

        // Add filters except pagination
        for (const key in filters) {
            if (filters.hasOwnProperty(key) && key !== 'page' && key !== 'limit' && key !== 'skip') {
                queryParams.append(key, filters[key]);
            }
        }
        
        const queryString = queryParams.toString();
        let url = `${baseUrl}?${queryString}`;


        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.articles && data.articles.length > 0) {
                placeholder.innerHTML = ''; // Clear loading message
                const ul = document.createElement('ul');
                ul.className = 'article-list-ul';

                data.articles.forEach(article => {
                    const li = document.createElement('li');
                    li.className = 'article-list-li';

                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'article-title';
                    const titleLink = document.createElement('a');
                    titleLink.href = article.url;
                    titleLink.textContent = article.title || 'No Title';
                    titleLink.target = '_blank'; // Open in new tab
                    titleDiv.appendChild(titleLink);

                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'article-meta';
                    const sourceSpan = document.createElement('span');
                    sourceSpan.textContent = `Source: ${article.source_name || 'N/A'}`;
                    
                    const dateSpan = document.createElement('span');
                    // Use publication_date if available, otherwise fetched_date
                    let displayDate = 'No Date';
                    if (article.publication_date) {
                        displayDate = new Date(article.publication_date).toLocaleDateString();
                    } else if (article.fetched_date) {
                        displayDate = new Date(article.fetched_date).toLocaleDateString() + " (fetched)";
                    }
                    dateSpan.textContent = ` | Date: ${displayDate}`;

                    metaDiv.appendChild(sourceSpan);
                    metaDiv.appendChild(dateSpan);

                    li.appendChild(titleDiv);
                    li.appendChild(metaDiv);
                    ul.appendChild(li);
                });
                placeholder.appendChild(ul);

                // Pagination controls
                if (data.pages && data.pages > 1) {
                    const paginationDiv = document.createElement('div');
                    paginationDiv.className = 'pagination'; // Use existing pagination styles if suitable

                    // Previous
                    if (data.page > 1) {
                        const firstBtn = document.createElement('a');
                        firstBtn.textContent = '« First';
                        firstBtn.href = '#';
                        firstBtn.onclick = (e) => { e.preventDefault(); activeFilters.page = 1; loadArticles(activeFilters); };
                        paginationDiv.appendChild(firstBtn);

                        const prevBtn = document.createElement('a');
                        prevBtn.textContent = '‹ Prev';
                        prevBtn.href = '#';
                        prevBtn.onclick = (e) => { e.preventDefault(); activeFilters.page = data.page - 1; loadArticles(activeFilters); };
                        paginationDiv.appendChild(prevBtn);
                    }

                    // Page numbers
                    let startPage = Math.max(1, data.page - 2);
                    let endPage = Math.min(data.pages, data.page + 2);
                    for (let p = startPage; p <= endPage; p++) {
                        const pageBtn = document.createElement('a');
                        pageBtn.textContent = p;
                        pageBtn.href = '#';
                        if (p === data.page) {
                            pageBtn.className = 'active';
                        }
                        pageBtn.onclick = (e) => { e.preventDefault(); activeFilters.page = p; loadArticles(activeFilters); };
                        paginationDiv.appendChild(pageBtn);
                    }

                    // Next
                    if (data.page < data.pages) {
                        const nextBtn = document.createElement('a');
                        nextBtn.textContent = 'Next ›';
                        nextBtn.href = '#';
                        nextBtn.onclick = (e) => { e.preventDefault(); activeFilters.page = data.page + 1; loadArticles(activeFilters); };
                        paginationDiv.appendChild(nextBtn);

                        const lastBtn = document.createElement('a');
                        lastBtn.textContent = 'Last »';
                        lastBtn.href = '#';
                        lastBtn.onclick = (e) => { e.preventDefault(); activeFilters.page = data.pages; loadArticles(activeFilters); };
                        paginationDiv.appendChild(lastBtn);
                    }

                    // Info
                    const infoSpan = document.createElement('span');
                    infoSpan.style.marginLeft = '16px';
                    infoSpan.style.color = '#888';
                    infoSpan.textContent = `Page ${data.page} of ${data.pages} (${data.total} articles)`;
                    paginationDiv.appendChild(infoSpan);

                    placeholder.appendChild(paginationDiv);
                }

            } else {
                placeholder.innerHTML = '<p>No articles found.</p>';
            }
        } catch (error) {
            console.error('Error loading articles:', error);
            placeholder.innerHTML = `<p>Error loading articles: ${error.message}</p>`;
        }
    }

    async function triggerDeepAnalysis() {
        const articleId = document.getElementById('articleIdInput').value.trim();
        if (!articleId) {
            document.getElementById('analysisResult').innerText = 'Please enter an Article ID.';
            return;
        }
        document.getElementById('analysisResult').innerText = 'Running deep analysis...';
        try {
            const resp = await fetch(`/api/articles/${articleId}/analyze-deeply`, { method: 'POST' });
            if (!resp.ok) {
                const err = await resp.json();
                document.getElementById('analysisResult').innerText = 'Error: ' + (err.detail || resp.statusText);
                return;
            }
            const data = await resp.json();
            document.getElementById('analysisResult').innerText = JSON.stringify(data.llm_deep_analysis_results || data, null, 2);
        } catch (e) {
            document.getElementById('analysisResult').innerText = 'Request failed: ' + e;
        }
    }

    async function triggerComparativeAnalysis() {
        const articleId = document.getElementById('articleIdInput').value.trim();
        if (!articleId) {
            document.getElementById('analysisResult').innerText = 'Please enter an Article ID.';
            return;
        }
        document.getElementById('analysisResult').innerText = 'Running comparative analysis...';
        try {
            const resp = await fetch(`/api/articles/${articleId}/comparative-analysis`, { method: 'POST' });
            if (!resp.ok) {
                const err = await resp.json();
                document.getElementById('analysisResult').innerText = 'Error: ' + (err.detail || resp.statusText);
                return;
            }
            const data = await resp.json();
            document.getElementById('analysisResult').innerText = JSON.stringify(data, null, 2);
        } catch (e) {
            document.getElementById('analysisResult').innerText = 'Request failed: ' + e;
        }
    }
    </script>

    <script>
        // Common chart colors and activeFilters should be in a scope accessible by chart configs
        // let activeFilters = {}; // Moved to the script block above loadArticles

        const chartColors = {
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(199, 199, 199, 0.6)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(199, 199, 199, 1)'
            ]
        };

        // Source Chart
        const sourceLabels = {{ sources.keys()|list|tojson }};
        const sourceData = {{ sources.values()|list|tojson }};
        
        const sourceCtx = document.getElementById('sourceChart').getContext('2d');
        const sourceChartInstance = new Chart(sourceCtx, { // Store instance
            type: 'bar',
            data: {
                labels: sourceLabels,
                datasets: [{
                    label: 'Articles Count',
                    data: sourceData,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                onClick: (event, elements) => {
                    handleChartClick(event, elements, sourceChartInstance, 'source_name');
                }
            }
        });

        // Category Chart
        const categoryLabels = {{ categories.keys()|list|tojson if categories else []|tojson }};
        const categoryData = {{ categories.values()|list|tojson if categories else []|tojson }};
        
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        const categoryChartInstance = new Chart(categoryCtx, { // Store instance
            type: 'pie',
            data: {
                labels: categoryLabels.length ? categoryLabels : ['No categorized articles'],
                datasets: [{
                    data: categoryData.length ? categoryData : [1],
                    backgroundColor: chartColors.backgroundColor,
                    borderColor: chartColors.borderColor,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                },
                onClick: (event, elements) => {
                    handleChartClick(event, elements, categoryChartInstance, 'llm_category');
                }
            }
        });
        
        // 1. Sentiment Chart
        const sentimentLabels = {{ sentiments.keys()|list|tojson if sentiments else []|tojson }};
        const sentimentData = {{ sentiments.values()|list|tojson if sentiments else []|tojson }};
        
        const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
        const sentimentChartInstance = new Chart(sentimentCtx, { // Store instance
            type: 'doughnut',
            data: {
                labels: sentimentLabels.length ? sentimentLabels : ['No sentiment data'],
                datasets: [{
                    data: sentimentData.length ? sentimentData : [1],
                    backgroundColor: chartColors.backgroundColor,
                    borderColor: chartColors.borderColor,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                },
                onClick: (event, elements) => {
                    // If a global sentiment filter is active from another click, this specific display area might be confusing.
                    // The handleChartClick function now clears this area if 'llm_sentiment' is in activeFilters.
                    // This chart will now also participate in global filtering.
                    handleChartClick(event, elements, sentimentChartInstance, 'llm_sentiment');

                    // The old functionality of displaying articles directly in sentimentArticlesDisplayArea
                    // is now superseded by the global filter and loadArticles,
                    // but we can keep the specific display area update if no global filter is set for sentiment.
                    // However, the prompt implies a unified filtering.
                    // For now, the specific display area will be managed by handleChartClick.
                }
            }
        });
        
        // 2. Publication Timeline Chart
        const timelineLabels = {{ timeline.keys()|list|tojson if timeline else []|tojson }};
        const timelineData = {{ timeline.values()|list|tojson if timeline else []|tojson }};
        
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: timelineLabels.length ? timelineLabels : ['No timeline data'],
                datasets: [{
                    label: 'Articles Published',
                    data: timelineData.length ? timelineData : [0],
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // 4. Key Claims Chart
        const keyClaimsLabels = {{ key_claims.keys()|list|tojson if key_claims else []|tojson }};
        const keyClaimsData = {{ key_claims.values()|list|tojson if key_claims else []|tojson }};
        
        const keyClaimsCtx = document.getElementById('keyClaimsChart').getContext('2d');
        const keyClaimsChartInstance = new Chart(keyClaimsCtx, { // Store instance
            type: 'horizontalBar', // Horizontal bar for better readability of claims
            data: {
                labels: keyClaimsLabels.length ? keyClaimsLabels : ['No key claims data'],
                datasets: [{
                    label: 'Frequency',
                    data: keyClaimsData.length ? keyClaimsData : [0],
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y', // For Chart.js v3+
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                onClick: (event, elements) => {
                    handleChartClick(event, elements, keyClaimsChartInstance, 'llm_key_claim');
                }
            }
        });
        // Fallback message for key claims
        if (!keyClaimsLabels.length || !keyClaimsData.length || (keyClaimsLabels.length === 1 && keyClaimsLabels[0] === 'No key claims data')) {
            document.getElementById('keyClaimsFallback').textContent = 'No key claims data available.';
        }

        // 5. Source Reliability Chart
        const reliabilityLabels = {{ sources_reliability.keys()|list|tojson if sources_reliability else []|tojson }};
        const reliabilityData = {{ sources_reliability.values()|list|tojson if sources_reliability else []|tojson }};
        
        const reliabilityCtx = document.getElementById('reliabilityChart').getContext('2d');
        new Chart(reliabilityCtx, {
            type: 'bar',
            data: {
                labels: reliabilityLabels.length ? reliabilityLabels : ['No reliability data'],
                datasets: [{
                    label: 'Reliability Score (%)',
                    data: reliabilityData.length ? reliabilityData : [0],
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100 // Percentage scale
                    }
                }
            }
        });
        // Fallback message for reliability
        if (!reliabilityLabels.length || !reliabilityData.length || (reliabilityLabels.length === 1 && reliabilityLabels[0] === 'No reliability data')) {
            document.getElementById('reliabilityFallback').textContent = 'No reliability data available.';
        }

        // 6. Deep Analysis Requirements Chart
        const deepAnalysisLabels = {{ deep_analysis_required.keys()|list|tojson if deep_analysis_required else []|tojson }};
        const deepAnalysisData = {{ deep_analysis_required.values()|list|tojson if deep_analysis_required else []|tojson }};
        
        const deepAnalysisRequiredCtx = document.getElementById('deepAnalysisRequiredChart').getContext('2d');
        const deepAnalysisRequiredChartInstance = new Chart(deepAnalysisRequiredCtx, { // Store instance
            type: 'pie',
            data: {
                labels: deepAnalysisLabels.length ? deepAnalysisLabels : ['No deep analysis data'],
                datasets: [{
                    data: deepAnalysisData.length ? deepAnalysisData : [1],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                },
                onClick: (event, elements) => {
                    handleChartClick(event, elements, deepAnalysisRequiredChartInstance, 'llm_requires_deep_analysis');
                }
            }
        });
        // Fallback message for deep analysis
        if (!deepAnalysisLabels.length || !deepAnalysisData.length || (deepAnalysisLabels.length === 1 && deepAnalysisLabels[0] === 'No deep analysis data')) {
            document.getElementById('deepAnalysisRequiredFallback').textContent = 'No deep analysis data available.';
        }
    </script>

    <!-- --- Robust Resizable Columns Logic (CSS Grid) --- -->
    <script>
        (function() {
            const dashboard = document.getElementById('dashboard-grid');
            const sidebarResizer = document.getElementById('sidebar-resizer');
            const graphsResizer = document.getElementById('graphs-resizer');

            // Set initial CSS vars if not set
            if (!dashboard.style.getPropertyValue('--sidebar-width')) dashboard.style.setProperty('--sidebar-width', '320px');
            if (!dashboard.style.getPropertyValue('--articles-width')) dashboard.style.setProperty('--articles-width', '400px');
            dashboard.style.setProperty('--resizer-width', '6px');

            // Prevent text selection while resizing
            function preventSelection(e) {
                e.preventDefault();
            }

            // Sidebar <-> Graphs resizer
            sidebarResizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                document.body.style.cursor = 'col-resize';
                sidebarResizer.classList.add('active');
                let startX = e.clientX;
                let startSidebarWidth = parseInt(getComputedStyle(dashboard).getPropertyValue('--sidebar-width'));
                document.addEventListener('selectstart', preventSelection); // Prevent text selection
                function onMouseMove(ev) {
                    let dx = ev.clientX - startX;
                    let newSidebarWidth = Math.max(180, Math.min(600, startSidebarWidth + dx));
                    dashboard.style.setProperty('--sidebar-width', newSidebarWidth + 'px');
                }
                function onMouseUp() {
                    document.body.style.cursor = '';
                    sidebarResizer.classList.remove('active');
                    window.removeEventListener('mousemove', onMouseMove);
                    window.removeEventListener('mouseup', onMouseUp);
                    document.removeEventListener('selectstart', preventSelection);
                }
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', onMouseUp);
            });

            // Graphs <-> Articles resizer
            graphsResizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                document.body.style.cursor = 'col-resize';
                graphsResizer.classList.add('active');
                let startX = e.clientX;
                let startArticlesWidth = parseInt(getComputedStyle(dashboard).getPropertyValue('--articles-width'));
                document.addEventListener('selectstart', preventSelection); // Prevent text selection
                function onMouseMove(ev) {
                    let dx = startX - ev.clientX;
                    let newArticlesWidth = Math.max(220, Math.min(700, startArticlesWidth + dx));
                    dashboard.style.setProperty('--articles-width', newArticlesWidth + 'px');
                }
                function onMouseUp() {
                    document.body.style.cursor = '';
                    graphsResizer.classList.remove('active');
                    window.removeEventListener('mousemove', onMouseMove);
                    window.removeEventListener('mouseup', onMouseUp);
                    document.removeEventListener('selectstart', preventSelection);
                }
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', onMouseUp);
            });
        })();
        // --- End Resizable Columns Logic ---
    </script>
</body>
</html>
