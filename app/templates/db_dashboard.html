<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Aggregator - Database Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .articles-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f1f5f9;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .api-link {
            display: inline-block;
            margin-top: 10px;
            color: #3498db;
            text-decoration: none;
        }
        .api-link:hover {
            text-decoration: underline;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination a {
            color: #3498db;
            padding: 8px 16px;
            text-decoration: none;
            border: 1px solid #ddd;
            margin: 0 4px;
            border-radius: 4px;
        }
        .pagination a:hover {
            background-color: #f1f5f9;
        }
        .pagination a.active {
            background-color: #3498db;
            color: white;
            border: 1px solid #3498db;
        }
        .article-summary {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* New styles for additional visualizations */
        .full-width {
            grid-column: 1 / -1;
        }
        
        .chart-note {
            color: #7f8c8d;
            font-size: 12px;
            font-style: italic;
            margin-top: 5px;
        }

        /* Styling for sentiment articles display area */
        #sentimentArticlesDisplayArea {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
            min-height: 70px; /* Adjusted to accommodate title and messages */
        }
        #sentimentArticlesDisplayArea h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #2c3e50;
        }
        #sentimentArticlesDisplayArea ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        #sentimentArticlesDisplayArea li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        #sentimentArticlesDisplayArea li:last-child {
            border-bottom: none;
        }
        #sentimentArticlesDisplayArea a {
            text-decoration: none;
            color: #3498db;
            font-weight: 500;
        }
        #sentimentArticlesDisplayArea a:hover {
            text-decoration: underline;
        }
        #sentimentArticlesDisplayArea .source-name {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-left: 5px;
        }
        #sentimentArticlesDisplayArea .message {
            color: #555;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>News Aggregator Database Dashboard</h1>
        <div>
            <a href="/docs" target="_blank" class="api-link">API Docs (Swagger)</a> |
            <a href="/redoc" target="_blank" class="api-link">API Docs (ReDoc)</a>
        </div>
    </div>

    <div class="action-section" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
        <h2>Article Actions</h2>
        <button id="fetchArticlesBtn" style="background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px;">Fetch New Articles</button>
        <div class="loader" id="fetchLoader" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin-left: 10px;"></div>
        <div class="status-area" id="fetchStatus" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #fdfdfd; min-height: 40px;">
            <p class="status-info" style="margin:0; color: #555;">Click to fetch articles from RSS feeds.</p>
        </div>
        <br>
        <button id="triageArticlesBtn" style="background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top:10px;">Triage New Articles (LLM Analysis)</button>
        <div class="loader" id="triageLoader" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin-left: 10px;"></div>
        <div class="status-area" id="triageStatus" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #fdfdfd; min-height: 40px;">
            <p class="status-info" style="margin:0; color: #555;">Click to perform LLM triage analysis.</p>
        </div>
    </div>

    <div class="stats-container">
        <div class="stats-card">
            <div class="stat-label">Total Articles</div>
            <div class="stat-value">{{ total_articles }}</div>
        </div>
        <div class="stats-card">
            <div class="stat-label">Storage Size</div>
            <div class="stat-value">{{ storage_size_mb }} MB</div>
        </div>
        <div class="stats-card">
            <div class="stat-label">Data Size</div>
            <div class="stat-value">{{ data_size_mb }} MB</div>
        </div>
        <!-- New: LLM Analysis Stats -->
        <div class="stats-card">
            <div class="stat-label">Triaged (LLM)</div>
            <div class="stat-value">{{ triaged_count }}</div>
        </div>
        <div class="stats-card">
            <div class="stat-label">Requires Deep Analysis</div>
            <div class="stat-value">{{ requires_deep_count }}</div>
        </div>
        <div class="stats-card">
            <div class="stat-label">Deep Analysis Done</div>
            <div class="stat-value">{{ deep_analysis_done_count }}</div>
        </div>
        <div class="stats-card">
            <div class="stat-label">Not Analyzed</div>
            <div class="stat-value">{{ not_analyzed_count }}</div>
        </div>
    </div>
    <div class="chart-container">
        <!-- Analysis Status Pie Chart -->
        <div class="chart-card full-width">
            <h3>Article Analysis Status Distribution</h3>
            <canvas id="analysisStatusChart"></canvas>
            <div class="chart-note">Shows the distribution of articles by LLM analysis status.</div>
        </div>
    </div>

    <script>
        // Render the analysis status pie chart
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('analysisStatusChart').getContext('2d');
            const data = {
                labels: {{ analysis_status_distribution.keys() | list | tojson }},
                datasets: [{
                    data: {{ analysis_status_distribution.values() | list | tojson }},
                    backgroundColor: [
                        '#3498db', // Triaged
                        '#e67e22', // Requires Deep
                        '#2ecc71', // Deep Done
                        '#95a5a6'  // Not Analyzed
                    ],
                }]
            };
            new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        });
    </script>

    <div class="chart-container">
        <div class="chart-card">
            <h2>Articles by Source</h2>
            <canvas id="sourceChart"></canvas>
            <a href="/api/db/articles?aggregate=source_name" class="api-link">View API data →</a>
        </div>
        <div class="chart-card">
            <h2>Articles by Category</h2>
            <canvas id="categoryChart"></canvas>
            <a href="/api/db/articles?aggregate=llm_category" class="api-link">View API data →</a>
        </div>
    </div>
    
    <!-- New visualizations -->
    <div class="chart-container">
        <!-- 1. Sentiment Analysis Chart -->
        <div class="chart-card">
            <h2>Article Sentiment Distribution</h2>
            <canvas id="sentimentChart"></canvas>
            <a href="/api/db/articles?aggregate=llm_sentiment" class="api-link">View API data →</a>
            <div id="sentimentArticlesDisplayArea">
                <!-- Articles will be displayed here -->
            </div>
        </div>
        
        <!-- 6. Deep Analysis Requirements -->
        <div class="chart-card">
            <h2>Articles Requiring Deep Analysis</h2>
            <canvas id="deepAnalysisRequiredChart"></canvas>
            <a href="/api/db/articles?aggregate=llm_requires_deep_analysis" class="api-link">View API data →</a>
        </div>
    </div>
    
    <!-- Timeline Chart -->
    <div class="chart-container">
        <!-- 2. Publication Timeline -->
        <div class="chart-card full-width">
            <h2>Publication Timeline</h2>
            <canvas id="timelineChart"></canvas>
            <a href="/api/db/articles?aggregate=publication_date" class="api-link">View API data →</a>
        </div>
    </div>
    
    <div class="chart-container">
        <!-- 4. Key Claims Analysis -->
        <div class="chart-card">
            <h2>Top Key Claims</h2>
            <canvas id="keyClaimsChart"></canvas>
            <a href="/api/db/articles?aggregate=llm_key_claim" class="api-link">View API data →</a>
        </div>
        
        <!-- 5. Source Reliability Metrics -->
        <div class="chart-card">
            <h2>Source Reliability Scores (%)</h2>
            <canvas id="reliabilityChart"></canvas>
            <p class="chart-note">Higher score = fewer articles requiring deep analysis</p>
        </div>
    </div>
    
    <!-- Deep Analysis Stats Card -->
    <div class="stats-card full-width">
        <div class="stat-label">Articles with Deep Analysis</div>
        <div class="stat-value">{{ deep_analysis_count }}</div>
        <div class="stat-label">of {{ total_articles }} total articles</div>
    </div>

    <div class="articles-container">
        <h2>Recent Articles</h2>
        <table>
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Source</th>
                    <th>Category</th>
                    <th>Publication Date</th>
                </tr>
            </thead>
            <tbody>
                {% for article in articles %}
                <tr>
                    <td>
                        <a href="{{ article.url }}" target="_blank">{{ article.title }}</a>
                        {% if article.summary %}
                        <div class="article-summary">{{ article.summary }}</div>
                        {% endif %}
                    </td>
                    <td>{{ article.source_name }}</td>
                    <td>{{ article.llm_category or "Uncategorized" }}</td>
                    <td>{{ article.publication_date or article.fetched_date }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination">
            <a href="#">&laquo;</a>
            <a href="#" class="active">1</a>
            <a href="#">2</a>
            <a href="#">3</a>
            <a href="#">&raquo;</a>
        </div>
        <a href="/api/db/articles" class="api-link">View all articles API data →</a>
    </div>

    <div class="articles-container full-width">
        <h2>Raw Database View (All Articles)</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>URL</th>
                    <th>Source Name</th>
                    <th>Fetched Date</th>
                    <th>Publication Date</th>
                    <th>LLM Category</th>
                    <th>LLM Sentiment</th>
                    <th>LLM Key Claim</th>
                    <th>LLM Requires Deep Analysis</th>
                    <!-- Add other headers as needed -->
                </tr>
            </thead>
            <tbody>
                {% for article in all_articles_for_raw_view %}
                <tr>
                    <td>{{ article._id }}</td>
                    <td>{{ article.title }}</td>
                    <td><a href="{{ article.url }}" target="_blank">{{ article.url }}</a></td>
                    <td>{{ article.source_name }}</td>
                    <td>{{ article.fetched_date }}</td>
                    <td>{{ article.publication_date }}</td>
                    <td>{{ article.llm_category }}</td>
                    <td>{{ article.llm_sentiment }}</td>
                    <td>{{ article.llm_key_claim }}</td>
                    <td>{{ article.llm_requires_deep_analysis }}</td>
                    <!-- Populate other cells as needed -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination">
            {% if raw_page > 1 %}
                <a href="?raw_page=1&raw_limit={{ raw_limit }}">&laquo; First</a>
                <a href="?raw_page={{ raw_page - 1 }}&raw_limit={{ raw_limit }}">&lsaquo; Prev</a>
            {% else %}
                <span class="active">&laquo; First</span>
                <span class="active">&lsaquo; Prev</span>
            {% endif %}

            {# Show up to 5 page numbers around the current page #}
            {% set start_page = raw_page - 2 if raw_page - 2 > 0 else 1 %}
            {% set end_page = raw_page + 2 if raw_page + 2 <= raw_total_pages else raw_total_pages %}
            {% for p in range(start_page, end_page + 1) %}
                {% if p == raw_page %}
                    <span class="active">{{ p }}</span>
                {% else %}
                    <a href="?raw_page={{ p }}&raw_limit={{ raw_limit }}">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if raw_page < raw_total_pages %}
                <a href="?raw_page={{ raw_page + 1 }}&raw_limit={{ raw_limit }}">Next &rsaquo;</a>
                <a href="?raw_page={{ raw_total_pages }}&raw_limit={{ raw_limit }}">Last &raquo;</a>
            {% else %}
                <span class="active">Next &rsaquo;</span>
                <span class="active">Last &raquo;</span>
            {% endif %}
            <span style="margin-left: 16px; color: #888;">Page {{ raw_page }} of {{ raw_total_pages }} ({{ raw_total_articles }} articles)</span>
        </div>
    </div>

    <!-- Advanced Article Analysis Section -->
    <div class="articles-container full-width" style="margin-top: 40px;">
        <h2>Advanced Article Analysis</h2>
        <form id="analysisForm" style="margin-bottom: 20px;">
            <label for="articleIdInput"><strong>Article ID:</strong></label>
            <input type="text" id="articleIdInput" name="article_id" placeholder="Enter Article ID" style="margin: 0 10px; padding: 4px 8px;">
            <button type="button" onclick="triggerDeepAnalysis()">Run Deep Analysis</button>
            <button type="button" onclick="triggerComparativeAnalysis()">Run Comparative Analysis</button>
        </form>
        <div id="analysisResult" style="background: #f8f9fa; border-radius: 6px; padding: 16px; min-height: 40px; margin-bottom: 10px;"></div>
        <div style="margin-top: 10px;">
            <a href="/docs#tag/Articles" class="api-link" target="_blank">API Docs: Article Analysis Endpoints →</a>
        </div>
    </div>

    <script>
    async function triggerDeepAnalysis() {
        const articleId = document.getElementById('articleIdInput').value.trim();
        if (!articleId) {
            document.getElementById('analysisResult').innerText = 'Please enter an Article ID.';
            return;
        }
        document.getElementById('analysisResult').innerText = 'Running deep analysis...';
        try {
            const resp = await fetch(`/api/articles/${articleId}/analyze-deeply`, { method: 'POST' });
            if (!resp.ok) {
                const err = await resp.json();
                document.getElementById('analysisResult').innerText = 'Error: ' + (err.detail || resp.statusText);
                return;
            }
            const data = await resp.json();
            document.getElementById('analysisResult').innerText = JSON.stringify(data.llm_deep_analysis_results || data, null, 2);
        } catch (e) {
            document.getElementById('analysisResult').innerText = 'Request failed: ' + e;
        }
    }

    async function triggerComparativeAnalysis() {
        const articleId = document.getElementById('articleIdInput').value.trim();
        if (!articleId) {
            document.getElementById('analysisResult').innerText = 'Please enter an Article ID.';
            return;
        }
        document.getElementById('analysisResult').innerText = 'Running comparative analysis...';
        try {
            const resp = await fetch(`/api/articles/${articleId}/comparative-analysis`, { method: 'POST' });
            if (!resp.ok) {
                const err = await resp.json();
                document.getElementById('analysisResult').innerText = 'Error: ' + (err.detail || resp.statusText);
                return;
            }
            const data = await resp.json();
            document.getElementById('analysisResult').innerText = JSON.stringify(data, null, 2);
        } catch (e) {
            document.getElementById('analysisResult').innerText = 'Request failed: ' + e;
        }
    }
    </script>

    <script>
        // Common chart colors
        const chartColors = {
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(199, 199, 199, 0.6)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(199, 199, 199, 1)'
            ]
        };

        // Source Chart
        const sourceLabels = {{ sources.keys()|list|tojson }};
        const sourceData = {{ sources.values()|list|tojson }};
        
        const sourceCtx = document.getElementById('sourceChart').getContext('2d');
        new Chart(sourceCtx, {
            type: 'bar',
            data: {
                labels: sourceLabels,
                datasets: [{
                    label: 'Articles Count',
                    data: sourceData,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Category Chart
        const categoryLabels = {{ categories.keys()|list|tojson if categories else []|tojson }};
        const categoryData = {{ categories.values()|list|tojson if categories else []|tojson }};
        
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'pie',
            data: {
                labels: categoryLabels.length ? categoryLabels : ['No categorized articles'],
                datasets: [{
                    data: categoryData.length ? categoryData : [1],
                    backgroundColor: chartColors.backgroundColor,
                    borderColor: chartColors.borderColor,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        // 1. Sentiment Chart
        const sentimentLabels = {{ sentiments.keys()|list|tojson if sentiments else []|tojson }};
        const sentimentData = {{ sentiments.values()|list|tojson if sentiments else []|tojson }};
        
        const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
        const sentimentChartInstance = new Chart(sentimentCtx, { // Store instance
            type: 'doughnut',
            data: {
                labels: sentimentLabels.length ? sentimentLabels : ['No sentiment data'],
                datasets: [{
                    data: sentimentData.length ? sentimentData : [1],
                    backgroundColor: chartColors.backgroundColor,
                    borderColor: chartColors.borderColor,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                },
                onClick: async (event, elements) => {
                    const displayArea = document.getElementById('sentimentArticlesDisplayArea');
                    // Clear previous content and show loading message
                    displayArea.innerHTML = '<p class="message">Loading articles...</p>'; 

                    if (elements.length > 0) {
                        const chartElement = elements[0];
                        const sentimentLabel = sentimentChartInstance.data.labels[chartElement.index];
                        
                        if (!sentimentLabel || sentimentLabel === 'No sentiment data') {
                            displayArea.innerHTML = '<p class="message">No specific sentiment selected or data available.</p>';
                            return;
                        }

                        // Add title before fetching
                        let titleHtml = `<h3>Articles for ${sentimentLabel}</h3>`;
                        
                        const encodedSentimentLabel = encodeURIComponent(sentimentLabel);
                        const apiUrl = `/api/db/articles_by_sentiment/${encodedSentimentLabel}`;

                        try {
                            const response = await fetch(apiUrl);
                            if (!response.ok) {
                                throw new Error(`API request failed with status ${response.status}`);
                            }
                            const data = await response.json();
                            
                            if (data.articles && data.articles.length > 0) {
                                let articlesHtml = '<ul>';
                                data.articles.forEach(article => {
                                    articlesHtml += `<li><a href="${article.url}" target="_blank">${article.title}</a> <span class="source-name">(Source: ${article.source_name})</span></li>`;
                                });
                                articlesHtml += '</ul>';
                                displayArea.innerHTML = titleHtml + articlesHtml; // Prepend title
                            } else if (data.articles && data.articles.length === 0) {
                                displayArea.innerHTML = titleHtml + '<p class="message">No articles found for this sentiment.</p>';
                            } else if (data.error) {
                                 displayArea.innerHTML = titleHtml + `<p class="message">Error: ${data.error}.</p>`;
                            } 
                            else {
                                 displayArea.innerHTML = titleHtml + `<p class="message">Error: Unexpected response format from server.</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
                            }
                        } catch (error) {
                            console.error('Error fetching articles by sentiment:', error);
                            displayArea.innerHTML = titleHtml + `<p class="message">Error fetching articles: ${error.message}</p>`;
                        }
                    } else {
                        // Click was not on a segment - clear the area or show a generic message
                        displayArea.innerHTML = '<p class="message">Click on a sentiment segment to see articles.</p>';
                    }
                }
            }
        });
        
        // 2. Publication Timeline Chart
        const timelineLabels = {{ timeline.keys()|list|tojson if timeline else []|tojson }};
        const timelineData = {{ timeline.values()|list|tojson if timeline else []|tojson }};
        
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: timelineLabels.length ? timelineLabels : ['No timeline data'],
                datasets: [{
                    label: 'Articles Published',
                    data: timelineData.length ? timelineData : [0],
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // 4. Key Claims Chart
        const keyClaimsLabels = {{ key_claims.keys()|list|tojson if key_claims else []|tojson }};
        const keyClaimsData = {{ key_claims.values()|list|tojson if key_claims else []|tojson }};
        
        const keyClaimsCtx = document.getElementById('keyClaimsChart').getContext('2d');
        new Chart(keyClaimsCtx, {
            type: 'horizontalBar', // Horizontal bar for better readability of claims
            data: {
                labels: keyClaimsLabels.length ? keyClaimsLabels : ['No key claims data'],
                datasets: [{
                    label: 'Frequency',
                    data: keyClaimsData.length ? keyClaimsData : [0],
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y', // For Chart.js v3+
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // 5. Source Reliability Chart
        const reliabilityLabels = {{ sources_reliability.keys()|list|tojson if sources_reliability else []|tojson }};
        const reliabilityData = {{ sources_reliability.values()|list|tojson if sources_reliability else []|tojson }};
        
        const reliabilityCtx = document.getElementById('reliabilityChart').getContext('2d');
        new Chart(reliabilityCtx, {
            type: 'bar',
            data: {
                labels: reliabilityLabels.length ? reliabilityLabels : ['No reliability data'],
                datasets: [{
                    label: 'Reliability Score (%)',
                    data: reliabilityData.length ? reliabilityData : [0],
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100 // Percentage scale
                    }
                }
            }
        });
        
        // 6. Deep Analysis Requirements Chart
        const deepAnalysisLabels = {{ deep_analysis_required.keys()|list|tojson if deep_analysis_required else []|tojson }};
        const deepAnalysisData = {{ deep_analysis_required.values()|list|tojson if deep_analysis_required else []|tojson }};
        
        const deepAnalysisRequiredCtx = document.getElementById('deepAnalysisRequiredChart').getContext('2d');
        new Chart(deepAnalysisRequiredCtx, {
            type: 'pie',
            data: {
                labels: deepAnalysisLabels.length ? deepAnalysisLabels : ['No deep analysis data'],
                datasets: [{
                    data: deepAnalysisData.length ? deepAnalysisData : [1],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    </script>
</body>
</html>
